# Nextclade Datasets Workflows

This repository documents the creation and development of Nextclade datasets that will be submitted to the official [nextclade_data](https://github.com/nextstrain/nextclade_data) repository by the **Instituto Todos pela SaÃºde (ITPS)**.

## Overview

[Nextclade](https://clades.nextstrain.org/) is a tool for viral genome analysis that provides clade assignment, mutation calling, and quality control. Each virus requires a curated dataset containing reference sequences, phylogenetic trees, and annotation files.

This repository contains:

- **Workflow scripts** for generating dataset components
- **Configuration files** for different viruses and variants
- **Resource files** (reference annotations, exclusion lists, etc.)
- **Documentation** of the dataset creation process

## Repository Structure

```
nextclade-datasets-workflows/
â”œâ”€â”€ README.md                    # This file
â”œâ”€â”€ get_resources/               # Dataset generation workflow
â”‚   â”œâ”€â”€ Snakefile               # Main Snakemake workflow
â”‚   â”œâ”€â”€ configs/                # Per-virus configuration files
â”‚   â”‚   â”œâ”€â”€ zikav/              # Zika virus dataset config
â”‚   â”‚   â”œâ”€â”€ orov_l_refseq/      # Oropouche L segment (RefSeq reference)
â”‚   â”‚   â”œâ”€â”€ orov_l_tefe/        # Oropouche L segment (Tefe reference)
â”‚   â”‚   â”œâ”€â”€ orov_m_refseq/      # Oropouche M segment (RefSeq reference)
â”‚   â”‚   â”œâ”€â”€ orov_m_tefe/        # Oropouche M segment (Tefe reference)
â”‚   â”‚   â”œâ”€â”€ orov_s_refseq/      # Oropouche S segment (RefSeq reference)
â”‚   â”‚   â””â”€â”€ orov_s_tefe/        # Oropouche S segment (Tefe reference)
â”‚   â”œâ”€â”€ scripts/                # Python scripts for data processing
â”‚   â””â”€â”€ workflow_env.yaml       # Conda environment specification
â””â”€â”€ <virus_name>                # Directory for virus-specific datasets
```

## get_resources Module

The `get_resources/` directory contains a Snakemake workflow that automates the creation of Nextclade datasets. It serves two main purposes:

### 1. Generate Test Datasets

The workflow creates complete, functional datasets for testing and validation before official submission. These test datasets include:

- `reference.fasta` - Reference genome sequence
- `genome_annotation.gff3` - Gene annotations in GFF3 format
- `tree.json` - Phylogenetic tree in Auspice JSON format
- `sequences.fasta` - Example sequences for testing
- `pathogen.json` - Nextclade configuration file

### 2. Generate Resource Files for Official Submissions

Many files generated by this workflow are used directly in the datasets submitted to `nextclade_data`. The `resources/` folder within each config directory contains:

| File | Description |
|------|-------------|
| `reference.fasta` | Reference genome sequence |
| `genome_annotation.gff3` | Gene annotations in GFF3 format |
| `sequences.fasta` | Example sequences for testing |

## Usage

### Prerequisites

Create the conda environment:

```bash
conda env create -f get_resources/workflow_env.yaml
conda activate nextclade-datasets
```

### Running the Workflow

Generate a dataset for a specific virus:

```bash
cd get_resources
snakemake --configfile configs/zikav/config.yaml --cores 4
```

Generate all datasets:

```bash
cd get_resources
for config in configs/*/*.yaml; do
    snakemake --configfile $config --cores 4
done
```

### Output

Results are saved in the `runs/` directory (gitignored), organized by virus name:

```
runs/<virus_name>/
â”œâ”€â”€ data/           # Raw downloaded data from NCBI
â”œâ”€â”€ results/        # Intermediate analysis files
â”œâ”€â”€ output/         # Reference and annotation files
â”œâ”€â”€ <dataset>/      # Final dataset files
â””â”€â”€ test_out/       # Nextclade test results
```

## Supported Viruses

| Virus | Segments | Reference(s) | Status |
|-------|----------|--------------|--------|
| Zika virus | Single | NC_035889.1 | âœ… Complete |
| Oropouche virus | L, M, S | RefSeq / Tefe | ðŸ”„ In development |

## Configuration

Each virus dataset is configured via a YAML file in `configs/<virus>/config.yaml`. Key parameters include:

```yaml
virus_name: "zikav"
dataset_name: "zikav_dataset"
reference_code: "NC_035889.1"
taxon_id: 64320

# Filtering parameters
min_length: 9714
max_seqs: 1100
allowed_divergence: 1500

# Reproducibility
example_sequences_seed: 42
```
